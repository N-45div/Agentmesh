# AgentMesh Code Intelligence Pipeline
# Triggers Kestra AI analysis on PRs and pushes
# For AI Agents Assemble Hackathon

name: AgentMesh Code Intelligence

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - security
          - bugs
          - prs

env:
  KESTRA_URL: ${{ secrets.KESTRA_URL }}
  AGENTMESH_URL: ${{ secrets.AGENTMESH_URL }}

jobs:
  # Job 1: Analyze repository with AI
  analyze:
    name: AI Code Analysis
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.ai_analysis.outputs.summary }}
      health: ${{ steps.ai_analysis.outputs.health }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather repository data
        id: repo_data
        run: |
          # Get recent commits
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          git log --oneline -10 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get changed files (for PRs)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Fetch open issues
        id: issues
        run: |
          echo "issues<<EOF" >> $GITHUB_OUTPUT
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&per_page=10" \
            | jq -r '.[] | "- \(.title) [\(.labels | map(.name) | join(", "))]"' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Analysis (Kestra)
        id: ai_analysis
        run: |
          # Prepare analysis data
          ANALYSIS_DATA=$(cat <<EOF
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Event: ${{ github.event_name }}
          
          Recent Commits:
          ${{ steps.repo_data.outputs.commits }}
          
          Open Issues:
          ${{ steps.issues.outputs.issues }}
          
          Changed Files:
          ${{ steps.repo_data.outputs.changed_files }}
          EOF
          )
          
          echo "üìä Repository Analysis Data:"
          echo "$ANALYSIS_DATA"
          
          # Determine health based on issues
          ISSUE_COUNT=$(echo "${{ steps.issues.outputs.issues }}" | grep -c "^-" || echo "0")
          
          if echo "${{ steps.issues.outputs.issues }}" | grep -qi "security\|critical"; then
            HEALTH="CRITICAL"
          elif [ "$ISSUE_COUNT" -gt 5 ]; then
            HEALTH="NEEDS_ATTENTION"
          else
            HEALTH="HEALTHY"
          fi
          
          echo "health=$HEALTH" >> $GITHUB_OUTPUT
          echo "summary=Analyzed ${{ github.repository }}: $ISSUE_COUNT open issues, health: $HEALTH" >> $GITHUB_OUTPUT

      - name: Trigger Kestra Workflow (if configured)
        if: env.KESTRA_URL != ''
        continue-on-error: true
        run: |
          curl -X POST "${{ env.KESTRA_URL }}/api/v1/executions/agentmesh/agentmesh-code-intel" \
            -H "Content-Type: application/json" \
            -d '{
              "inputs": {
                "github_repo": "${{ github.repository }}",
                "agentmesh_url": "${{ env.AGENTMESH_URL }}"
              }
            }'

      - name: Post Analysis Summary
        run: |
          echo "## ü§ñ AgentMesh Code Intelligence Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Status:** ${{ steps.ai_analysis.outputs.health }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Open Issues" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.issues.outputs.issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent Commits" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.repo_data.outputs.commits }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 2: Run Cline on self-hosted runner (if available)
  cline-analysis:
    name: Cline Code Analysis
    needs: analyze
    if: needs.analyze.outputs.health == 'CRITICAL' || needs.analyze.outputs.health == 'NEEDS_ATTENTION'
    runs-on: self-hosted  # Requires self-hosted runner with Cline installed
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Cline installation
        id: cline_check
        run: |
          if command -v cline &> /dev/null; then
            echo "installed=true" >> $GITHUB_OUTPUT
            cline version
          else
            echo "installed=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Cline CLI not found on this runner"
          fi

      - name: Run Cline Security Audit
        if: steps.cline_check.outputs.installed == 'true' && needs.analyze.outputs.health == 'CRITICAL'
        run: |
          echo "üîí Running Cline security audit..."
          cline -y --oneshot "Perform a security audit on this codebase. Focus on: authentication, data validation, and dependency vulnerabilities."

      - name: Run Cline Code Review
        if: steps.cline_check.outputs.installed == 'true' && needs.analyze.outputs.health == 'NEEDS_ATTENTION'
        run: |
          echo "üìù Running Cline code review..."
          cline -y --oneshot "Review this codebase for bugs and code quality issues. Provide a summary of findings."

  # Job 3: Comment on PR with results
  comment:
    name: Post Results
    needs: [analyze, cline-analysis]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const health = '${{ needs.analyze.outputs.health }}';
            const emoji = health === 'CRITICAL' ? 'üö®' : health === 'NEEDS_ATTENTION' ? '‚ö†Ô∏è' : '‚úÖ';
            
            const body = `## ${emoji} AgentMesh Code Intelligence
            
            **Health Status:** ${health}
            
            **Summary:** ${{ needs.analyze.outputs.summary }}
            
            ---
            *Powered by [AgentMesh](https://github.com/N-45div/Agentmesh) - AI Agents Assemble Hackathon*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
